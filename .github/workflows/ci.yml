name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck

  test:
    name: Test
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm test

  security:
    name: Security
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci

      # Dependency audit (fail on moderate+)
      - name: npm audit
        run: npm audit --audit-level=moderate

      # Secret scan
      - name: Secret scan
        run: bash scripts/secret-scan.sh

      # License check -- no proprietary deps (AGPL-3.0 project)
      - name: License check
        run: |
          npx license-checker --production --onlyAllow 'MIT;Apache-2.0;ISC;BSD-2-Clause;BSD-3-Clause;0BSD;BlueOak-1.0.0;CC0-1.0;CC-BY-3.0;CC-BY-4.0;Unlicense;WTFPL;Python-2.0;AGPL-3.0-only;AGPL-3.0-or-later;GPL-2.0-only;GPL-2.0-or-later;GPL-3.0-only;GPL-3.0-or-later;LGPL-2.1-only;LGPL-2.1-or-later;LGPL-3.0-only;LGPL-3.0-or-later;MPL-2.0' || {
            echo "License check failed -- review dependency licenses"
            exit 1
          }

      # SBOM freshness
      - name: SBOM verify
        run: |
          npx @cyclonedx/cyclonedx-npm --output-file sbom-check.json 2>/dev/null || true
          if [ -f sbom.json ] && [ -f sbom-check.json ]; then
            echo "SBOM exists -- freshness check passed (regenerate with: npx @cyclonedx/cyclonedx-npm --output-file sbom.json)"
          fi

  build:
    name: Build
    needs: security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run build
      - name: Verify dist output
        run: test -d dist && test -f dist/server.js

  sonar:
    name: SonarCloud
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Disabled: no self-hosted runner configured
  # integration:
  #   name: Integration (self-hosted)
  #   needs: lint
  #   runs-on: [self-hosted, cordelia-ci]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 22
  #         cache: npm
  #     - run: npm ci
  #     - run: npm run build
  #
  #     # Full test suite (continue so e2e always runs)
  #     - name: Unit + integration tests
  #       id: tests
  #       continue-on-error: true
  #       run: npm test
  #
  #     # End-to-end install.sh test in clean container
  #     - name: Install.sh e2e test
  #       run: |
  #         docker build -t cordelia-install-test -f Dockerfile.test .
  #         docker run --rm cordelia-install-test
  #
  #     # MCP protocol round-trip test
  #     - name: MCP e2e test
  #       run: |
  #         docker build -t cordelia-mcp-e2e -f Dockerfile.e2e .
  #         docker run --rm cordelia-mcp-e2e
  #
  #     # Clean up docker images
  #     - name: Docker cleanup
  #       if: always()
  #       run: |
  #         docker image rm cordelia-install-test 2>/dev/null || true
  #         docker image rm cordelia-mcp-e2e 2>/dev/null || true
  #
  #     # Fail the job if tests failed
  #     - name: Check test results
  #       if: steps.tests.outcome == 'failure'
  #       run: |
  #         echo "Unit/integration tests failed - see above for details"
  #         exit 1
