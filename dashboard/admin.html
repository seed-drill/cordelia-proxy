<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cordelia - Admin</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .admin-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .admin-header h2 {
      color: var(--color-deep-green);
      margin: 0;
    }

    .stats-row {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1.25rem;
      flex: 1;
      text-align: center;
    }

    .stat-card .count {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-deep-green);
    }

    .stat-card .label {
      font-size: 0.85rem;
      color: var(--color-muted);
      text-transform: uppercase;
    }

    .users-table {
      width: 100%;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      border-collapse: collapse;
      overflow: hidden;
    }

    .users-table th,
    .users-table td {
      padding: 0.875rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .users-table th {
      background: var(--color-deep-green);
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .users-table tr:last-child td {
      border-bottom: none;
    }

    .users-table tr:hover td {
      background: #f9f9f9;
    }

    .user-name {
      font-weight: 600;
      color: var(--color-charcoal);
    }

    .user-github {
      color: var(--color-muted);
      font-size: 0.85rem;
    }

    .role-tag {
      display: inline-block;
      background: var(--color-deep-green);
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      margin-right: 0.25rem;
    }

    .session-count {
      font-weight: 600;
      color: var(--color-copper);
    }

    .error-row {
      color: var(--color-muted);
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--color-muted);
    }

    .back-link {
      color: white;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logout-btn {
      padding: 0.4rem 1rem;
      background-color: var(--color-copper);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .core-status-panel {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .core-status-panel h3 {
      margin: 0 0 1rem 0;
      color: var(--color-deep-green);
      font-size: 1rem;
    }

    .core-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .core-status-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .core-status-item .label {
      font-size: 0.75rem;
      color: var(--color-muted);
      text-transform: uppercase;
    }

    .core-status-item .value {
      font-weight: 600;
      color: var(--color-charcoal);
    }

    .core-status-item .value.connected {
      color: var(--color-deep-green);
    }

    .core-status-item .value.disconnected {
      color: #c00;
    }

    .monospace {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .peer-list-panel {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .peer-list-panel h3 {
      margin: 0 0 1rem 0;
      color: var(--color-deep-green);
      font-size: 1rem;
    }

    .peers-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .peers-table th,
    .peers-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .peers-table th {
      background: #f5f5f5;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--color-muted);
    }

    .peers-table tr:last-child td {
      border-bottom: none;
    }

    .peers-table .no-peers {
      text-align: center;
      color: var(--color-muted);
      font-style: italic;
      padding: 1rem;
    }

    .peer-state {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .peer-state.hot {
      background: var(--color-deep-green);
      color: white;
    }

    .peer-state.warm {
      background: var(--color-copper);
      color: white;
    }

    .peer-state.cold {
      background: #717171;
      color: white;
    }

    .peer-node-id {
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
    }

    .peer-groups {
      font-size: 0.75rem;
      color: var(--color-muted);
    }

    .bootnode-status {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .bootnode-status.ok {
      background: var(--color-deep-green);
      color: white;
    }

    .bootnode-status.dns-fail {
      background: #c00;
      color: white;
    }

    .bootnode-status.tcp-fail {
      background: var(--color-copper);
      color: white;
    }

    .bootnode-actions {
      text-align: center;
      width: 60px;
    }

    .btn-remove {
      background: none;
      border: 1px solid #c00;
      color: #c00;
      border-radius: 4px;
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .btn-remove:hover {
      background: #c00;
      color: white;
    }

    .bootnode-add-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      align-items: center;
    }

    .bootnode-add-form input {
      flex: 1;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .btn-add {
      padding: 0.4rem 1rem;
      background: var(--color-deep-green);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .btn-add:hover {
      opacity: 0.9;
    }

    .bootnode-panel-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--color-border);
    }

    .btn-restart {
      padding: 0.5rem 1.25rem;
      background: var(--color-copper);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .btn-restart:hover {
      opacity: 0.9;
    }

    .btn-restart:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .restart-badge {
      display: none;
      background: var(--color-copper);
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .restart-badge.visible {
      display: inline-block;
    }

    .env-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .env-table td {
      padding: 0.35rem 0.75rem;
      border-bottom: 1px solid var(--color-border);
      vertical-align: top;
    }

    .env-table tr:last-child td {
      border-bottom: none;
    }

    .env-table .env-key {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: var(--color-charcoal);
      white-space: nowrap;
      width: 1%;
    }

    .env-table .env-val {
      font-family: 'Courier New', monospace;
      color: var(--color-deep-green);
      word-break: break-all;
    }

    .env-table .env-val.unset {
      color: var(--color-muted);
      font-style: italic;
    }

    .env-table .env-val.masked {
      color: var(--color-copper);
    }
  </style>
</head>
<body>
  <header>
    <h1>Cordelia</h1>
    <div class="header-actions" id="header-actions">
      <a href="/" class="back-link">Back to Dashboard</a>
    </div>
  </header>

  <main class="admin-container">
    <div class="admin-header">
      <h2>Admin Panel</h2>
    </div>

    <div id="loading" class="loading">Loading...</div>

    <div id="content" style="display: none;">
      <!-- Core Node Connection Status -->
      <div class="core-status-panel" id="core-status-panel">
        <h3>Core Node Connection</h3>
        <div class="core-status-grid">
          <div class="core-status-item">
            <span class="label">Status:</span>
            <span class="value" id="core-connection-status">Checking...</span>
          </div>
          <div class="core-status-item">
            <span class="label">Node ID:</span>
            <span class="value monospace" id="core-node-id">-</span>
          </div>
          <div class="core-status-item">
            <span class="label">Entity ID:</span>
            <span class="value" id="core-entity-id">-</span>
          </div>
          <div class="core-status-item">
            <span class="label">Uptime:</span>
            <span class="value" id="core-uptime">-</span>
          </div>
          <div class="core-status-item">
            <span class="label">API Endpoint:</span>
            <span class="value monospace" id="core-api-endpoint">-</span>
          </div>
        </div>
      </div>

      <!-- P2P Network Stats -->
      <div class="stats-row" id="peer-stats">
        <div class="stat-card">
          <div class="count" id="peer-hot">-</div>
          <div class="label">Hot Peers</div>
        </div>
        <div class="stat-card">
          <div class="count" id="peer-warm">-</div>
          <div class="label">Warm Peers</div>
        </div>
        <div class="stat-card">
          <div class="count" id="peer-total">-</div>
          <div class="label">Total Peers</div>
        </div>
        <div class="stat-card">
          <div class="count" id="network-status">-</div>
          <div class="label">Network</div>
        </div>
      </div>

      <!-- Bootnode Status -->
      <div class="peer-list-panel" id="bootnode-panel">
        <h3>Bootnode Servers <span class="restart-badge" id="restart-badge">Restart Required</span></h3>
        <table class="peers-table" id="bootnodes-table">
          <thead>
            <tr>
              <th>QUIC Status</th>
              <th>Address</th>
              <th>IP</th>
              <th class="bootnode-actions"></th>
            </tr>
          </thead>
          <tbody id="bootnodes-tbody">
            <tr><td colspan="4" class="no-peers">Checking...</td></tr>
          </tbody>
        </table>
        <div class="bootnode-add-form">
          <input type="text" id="bootnode-addr-input" placeholder="host:port (e.g. boot3.example.com:9474)">
          <button class="btn-add" onclick="addBootnode()">Add Bootnode</button>
        </div>
        <div class="bootnode-panel-footer">
          <span id="bootnode-feedback" style="font-size:0.85rem; color:var(--color-muted);"></span>
          <button class="btn-restart" id="restart-btn" onclick="restartNode()">Restart Node</button>
        </div>
      </div>

      <!-- Peer List -->
      <div class="peer-list-panel" id="peer-list-panel">
        <h3>Connected Peers</h3>
        <table class="peers-table" id="peers-table">
          <thead>
            <tr>
              <th>State</th>
              <th>Node ID</th>
              <th>Address</th>
              <th>RTT</th>
              <th>Groups</th>
            </tr>
          </thead>
          <tbody id="peers-tbody">
            <tr><td colspan="5" class="no-peers">No connected peers</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Environment Config -->
      <div class="peer-list-panel" id="env-panel">
        <h3>Environment</h3>
        <table class="env-table">
          <tbody id="env-tbody">
            <tr><td colspan="2" class="no-peers">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Memory Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="count" id="user-count">0</div>
          <div class="label">Users</div>
        </div>
        <div class="stat-card">
          <div class="count" id="entity-count">0</div>
          <div class="label">Entities</div>
        </div>
        <div class="stat-card">
          <div class="count" id="session-count">0</div>
          <div class="label">Sessions</div>
        </div>
        <div class="stat-card">
          <div class="count" id="learning-count">0</div>
          <div class="label">Learnings</div>
        </div>
      </div>

      <table class="users-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Organisation</th>
            <th>Roles</th>
            <th>Sessions</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <!-- Users will be added here -->
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    <p>Project Cordelia - Seed Drill</p>
  </footer>

  <script type="module">
    const API_BASE = '';

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      return date.toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    }

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/auth/status`);
        const data = await response.json();

        if (!data.authenticated) {
          window.location.href = '/';
          return null;
        }

        return data;
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/';
        return null;
      }
    }

    async function loadCoreStatus() {
      const statusEl = document.getElementById('core-connection-status');
      const nodeIdEl = document.getElementById('core-node-id');
      const entityIdEl = document.getElementById('core-entity-id');
      const uptimeEl = document.getElementById('core-uptime');
      const apiEndpointEl = document.getElementById('core-api-endpoint');

      try {
        const response = await fetch(`${API_BASE}/api/core/status`);
        const data = await response.json();

        if (data.connected) {
          statusEl.textContent = 'Connected';
          statusEl.className = 'value connected';
          nodeIdEl.textContent = data.node_id ? data.node_id.substring(0, 16) + '...' : '-';
          nodeIdEl.title = data.node_id || '';
          entityIdEl.textContent = data.entity_id || '-';
          uptimeEl.textContent = formatUptime(data.uptime_secs);
          apiEndpointEl.textContent = data.api_endpoint || '-';

          // Update peer counts from core status
          if (data.peers) {
            document.getElementById('peer-hot').textContent = data.peers.hot ?? '-';
            document.getElementById('peer-warm').textContent = data.peers.warm ?? '-';
            document.getElementById('peer-total').textContent = data.peers.total ?? '-';

            if (data.peers.total > 0) {
              document.getElementById('network-status').textContent = 'Online';
              document.getElementById('network-status').style.color = 'var(--color-deep-green)';
            } else {
              document.getElementById('network-status').textContent = 'Isolated';
              document.getElementById('network-status').style.color = 'var(--color-copper)';
            }
          }
        } else {
          statusEl.textContent = 'Disconnected';
          statusEl.className = 'value disconnected';
          nodeIdEl.textContent = '-';
          entityIdEl.textContent = '-';
          uptimeEl.textContent = '-';
          apiEndpointEl.textContent = data.api_endpoint || '-';
          document.getElementById('network-status').textContent = 'Offline';
          document.getElementById('network-status').style.color = '#595959';
        }
      } catch (error) {
        console.error('Core status error:', error);
        statusEl.textContent = 'Error';
        statusEl.className = 'value disconnected';
      }
    }

    function formatUptime(seconds) {
      if (!seconds) return '-';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      }
      return `${minutes}m`;
    }

    async function loadPeerList() {
      const tbody = document.getElementById('peers-tbody');

      try {
        const response = await fetch(`${API_BASE}/api/peers`);
        const data = await response.json();

        // Update counts
        document.getElementById('peer-hot').textContent = data.hot ?? '-';
        document.getElementById('peer-warm').textContent = data.warm ?? '-';
        document.getElementById('peer-total').textContent = data.total ?? '-';

        if (data.error) {
          document.getElementById('network-status').textContent = 'Offline';
          document.getElementById('network-status').style.color = '#595959';
        } else if (data.total > 0) {
          document.getElementById('network-status').textContent = 'Online';
          document.getElementById('network-status').style.color = 'var(--color-deep-green)';
        } else {
          document.getElementById('network-status').textContent = 'Isolated';
          document.getElementById('network-status').style.color = 'var(--color-copper)';
        }

        // Update peer list table
        if (!data.peers || data.peers.length === 0) {
          const msg = data.total > 0
            ? `${data.total} peer(s) connected (upgrade core node for details)`
            : 'No connected peers';
          tbody.innerHTML = `<tr><td colspan="5" class="no-peers">${msg}</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        for (const peer of data.peers) {
          const tr = document.createElement('tr');
          const stateClass = peer.state.toLowerCase();
          const nodeIdShort = peer.node_id ? peer.node_id.substring(0, 12) + '...' : '-';
          const rttText = peer.rtt_ms !== null ? `${peer.rtt_ms.toFixed(1)}ms` : '-';
          const groupsText = peer.groups && peer.groups.length > 0
            ? peer.groups.join(', ')
            : '-';

          tr.innerHTML = `
            <td><span class="peer-state ${stateClass}">${escapeHtml(peer.state)}</span></td>
            <td class="peer-node-id" title="${escapeHtml(peer.node_id)}">${escapeHtml(nodeIdShort)}</td>
            <td class="monospace">${escapeHtml(peer.addrs?.[0] || '-')}</td>
            <td>${rttText}</td>
            <td class="peer-groups">${escapeHtml(groupsText)}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (error) {
        console.error('Peer list error:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="no-peers">Error loading peers</td></tr>';
      }
    }

    async function loadPeerData() {
      try {
        const response = await fetch(`${API_BASE}/api/peers`);
        const data = await response.json();

        document.getElementById('peer-hot').textContent = data.hot ?? '-';
        document.getElementById('peer-warm').textContent = data.warm ?? '-';
        document.getElementById('peer-total').textContent = data.total ?? '-';

        if (data.error) {
          document.getElementById('network-status').textContent = 'Offline';
          document.getElementById('network-status').style.color = '#595959';
        } else if (data.total > 0) {
          document.getElementById('network-status').textContent = 'Online';
          document.getElementById('network-status').style.color = 'var(--color-deep-green)';
        } else {
          document.getElementById('network-status').textContent = 'Isolated';
          document.getElementById('network-status').style.color = 'var(--color-copper)';
        }
      } catch (error) {
        console.error('Peer data error:', error);
        document.getElementById('network-status').textContent = 'Error';
      }
    }

    async function loadAdminData() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/users`);

        if (!response.ok) {
          throw new Error(`Failed: ${response.statusText}`);
        }

        const data = await response.json();

        // Update stats
        document.getElementById('user-count').textContent = data.total_users;
        document.getElementById('entity-count').textContent = data.l2_stats.entities;
        document.getElementById('session-count').textContent = data.l2_stats.sessions;
        document.getElementById('learning-count').textContent = data.l2_stats.learnings;

        // Populate users table
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = '';

        for (const user of data.users) {
          const tr = document.createElement('tr');

          if (user.error) {
            tr.className = 'error-row';
            tr.innerHTML = `
              <td colspan="5">${escapeHtml(user.id)} - ${escapeHtml(user.error)}</td>
            `;
          } else {
            const rolesHtml = (user.roles || [])
              .map(r => `<span class="role-tag">${escapeHtml(r)}</span>`)
              .join('');

            tr.innerHTML = `
              <td>
                <div class="user-name">${escapeHtml(user.name)}</div>
                ${user.github_id ? `<div class="user-github">@${escapeHtml(user.github_id)}</div>` : ''}
              </td>
              <td>${escapeHtml(user.org) || '-'}</td>
              <td>${rolesHtml || '-'}</td>
              <td><span class="session-count">${user.session_count || 0}</span></td>
              <td>${formatDate(user.updated_at)}</td>
            `;
          }

          tbody.appendChild(tr);
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

      } catch (error) {
        console.error('Admin load error:', error);
        document.getElementById('loading').textContent = `Error: ${error.message}`;
      }
    }

    async function loadBootnodeStatus() {
      const tbody = document.getElementById('bootnodes-tbody');

      try {
        const response = await fetch(`${API_BASE}/api/core/bootnodes`);
        const data = await response.json();

        if (!data.bootnodes || data.bootnodes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="no-peers">No bootnodes configured</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        for (const node of data.bootnodes) {
          const tr = document.createElement('tr');
          let statusClass, statusText;

          if (!node.dns_ok) {
            statusClass = 'dns-fail';
            statusText = 'DNS Fail';
          } else if (node.quic_status === 'connected') {
            statusClass = 'ok';
            statusText = 'Connected';
          } else if (node.quic_status === 'dial_failed') {
            statusClass = 'tcp-fail';
            statusText = 'Dial Failed';
          } else {
            statusClass = 'tcp-fail';
            statusText = 'Unknown';
          }

          const errorTitle = node.error ? ` title="${escapeHtml(node.error)}"` : '';
          const encodedAddr = encodeURIComponent(node.addr);

          tr.innerHTML = `
            <td><span class="bootnode-status ${statusClass}"${errorTitle}>${statusText}</span></td>
            <td class="monospace">${escapeHtml(node.addr)}</td>
            <td class="monospace">${escapeHtml(node.ip || '-')}</td>
            <td class="bootnode-actions"><button class="btn-remove" onclick="removeBootnode('${encodedAddr}')" title="Remove bootnode">x</button></td>
          `;
          tbody.appendChild(tr);
        }
      } catch (error) {
        console.error('Bootnode status error:', error);
        tbody.innerHTML = '<tr><td colspan="4" class="no-peers">Error checking bootnodes</td></tr>';
      }
    }

    function showRestartBadge() {
      document.getElementById('restart-badge').classList.add('visible');
    }

    function setBootnodeFeedback(msg, isError) {
      const el = document.getElementById('bootnode-feedback');
      el.textContent = msg;
      el.style.color = isError ? '#c00' : 'var(--color-deep-green)';
      if (msg) setTimeout(() => { el.textContent = ''; }, 5000);
    }

    async function addBootnode() {
      const input = document.getElementById('bootnode-addr-input');
      const addr = input.value.trim();
      if (!addr) return;

      try {
        const resp = await fetch(`${API_BASE}/api/core/bootnodes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ addr }),
        });
        const data = await resp.json();

        if (!resp.ok) {
          setBootnodeFeedback(data.error || 'Failed to add bootnode', true);
          return;
        }

        input.value = '';
        showRestartBadge();
        setBootnodeFeedback(`Added ${addr}`, false);
        loadBootnodeStatus();
      } catch (error) {
        setBootnodeFeedback('Network error', true);
      }
    }

    async function removeBootnode(encodedAddr) {
      const addr = decodeURIComponent(encodedAddr);
      if (!confirm(`Remove bootnode ${addr}?`)) return;

      try {
        const resp = await fetch(`${API_BASE}/api/core/bootnodes/${encodedAddr}`, {
          method: 'DELETE',
        });
        const data = await resp.json();

        if (!resp.ok) {
          setBootnodeFeedback(data.error || 'Failed to remove bootnode', true);
          return;
        }

        showRestartBadge();
        setBootnodeFeedback(`Removed ${addr}`, false);
        loadBootnodeStatus();
      } catch (error) {
        setBootnodeFeedback('Network error', true);
      }
    }

    async function restartNode() {
      if (!confirm('Restart cordelia-node? This will briefly disconnect peers.')) return;

      const btn = document.getElementById('restart-btn');
      btn.disabled = true;
      btn.textContent = 'Restarting...';
      setBootnodeFeedback('', false);

      try {
        const resp = await fetch(`${API_BASE}/api/core/restart`, {
          method: 'POST',
        });
        const data = await resp.json();

        if (!resp.ok) {
          setBootnodeFeedback(data.error || 'Restart failed', true);
          return;
        }

        document.getElementById('restart-badge').classList.remove('visible');

        if (data.healthy) {
          setBootnodeFeedback('Node restarted successfully', false);
        } else {
          setBootnodeFeedback('Node restarted but health check pending', true);
        }

        // Refresh all status panels
        setTimeout(() => {
          loadCoreStatus();
          loadPeerList();
          loadBootnodeStatus();
        }, 1000);
      } catch (error) {
        setBootnodeFeedback('Network error during restart', true);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Restart Node';
      }
    }

    async function loadEnvConfig() {
      const tbody = document.getElementById('env-tbody');
      try {
        const resp = await fetch(`${API_BASE}/api/env`);
        const data = await resp.json();
        tbody.innerHTML = '';
        for (const [key, val] of Object.entries(data)) {
          const tr = document.createElement('tr');
          let valClass = 'env-val';
          let display;
          if (val === undefined || val === null) {
            valClass += ' unset';
            display = 'not set';
          } else if (val === '***') {
            valClass += ' masked';
            display = '***';
          } else {
            display = String(val);
          }
          tr.innerHTML = `<td class="env-key">${escapeHtml(key)}</td><td class="${valClass}">${escapeHtml(display)}</td>`;
          tbody.appendChild(tr);
        }
      } catch (error) {
        console.error('Env config error:', error);
        tbody.innerHTML = '<tr><td colspan="2" class="no-peers">Error loading env</td></tr>';
      }
    }

    async function init() {
      const auth = await checkAuth();
      if (!auth) return;

      // Update header with user
      const headerActions = document.getElementById('header-actions');
      const userLabel = auth.github_login || auth.cordelia_user || auth.username || '';
      headerActions.innerHTML = `
        ${userLabel ? `<span style="font-size: 0.9rem; opacity: 0.9;">@${userLabel}</span>` : ''}
        <a href="/" class="back-link">Dashboard</a>
        ${auth.auth_type !== 'local' ? `<button class="logout-btn" onclick="logout()">Logout</button>` : ''}
      `;

      loadAdminData();
      loadCoreStatus();
      loadPeerList();
      loadBootnodeStatus();
      loadEnvConfig();

      // Refresh status every 30 seconds
      setInterval(loadCoreStatus, 30000);
      setInterval(loadPeerList, 30000);
      setInterval(loadBootnodeStatus, 30000);
    }

    async function logout() {
      await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
      window.location.href = '/';
    }

    await init();
  </script>
</body>
</html>
